{% extends 'common/base.html' %}
{% load static %}
{% load money %}
{% load utils %}

{% block category_css %}
    <link rel="stylesheet" href="{% static 'css/category/category.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/likes.css' %}">
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet"  href="{% static 'css/components/likes.css' %}">
{% endblock %}

{% block content %}
    <main class="container page">

        {% include 'jewels/category-filter.html' %}

        <section class="content">
            <div class="toolbar">
                <div class="left">
                    <h1 class="category-title">{{ current_category.name|upper }}</h1>
                </div>

                <div class="right controls">
                    <label class="control">
                        <span>Sort by:</span>
                        <select name="order" form="filters">
                            <option value="newest" {% if order == 'newest' %}selected{% endif %}>Newest first</option>
                            <option value="oldest" {% if order == 'oldest' %}selected{% endif %}>Oldest first</option>
                            <option value="price_asc" {% if order == 'price_asc' %}selected{% endif %}>Price: low →
                                high
                            </option>
                            <option value="price_desc" {% if order == 'price_desc' %}selected{% endif %}>Price: high →
                                low
                            </option>
                            <option value="rating_desc" {% if order == 'rating_desc' %}selected{% endif %}>Rating: high
                                → low
                            </option>
                            <option value="rating_asc" {% if order == 'rating_asc' %}selected{% endif %}>Rating: low →
                                high
                            </option>
                        </select>
                    </label>

                    <div class="view-toggles" role="group" aria-label="View">
                        {% with current_view=request.GET.view|default:'grid' %}
                            <a
                                    class="icon-btn {% if request.GET.view|default:'grid' == 'grid' %}active{% endif %}"
                                    href="?{{ qs }}{% if qs %}&{% endif %}view=grid"
                                    aria-label="Grid view"
                                    title="Grid view"
                            >
                                <i class="fa-solid fa-table-cells" aria-hidden="true"></i>
                            </a>

                            <a
                                    class="icon-btn {% if request.GET.view == 'list' %}active{% endif %}"
                                    href="?{{ qs }}{% if qs %}&{% endif %}view=list"
                                    aria-label="List view"
                                    title="List view"
                            >
                                <i class="fa-solid fa-list-ul" aria-hidden="true"></i>
                            </a>
                        {% endwith %}
                    </div>
                </div>
            </div>

            {% with current_view=request.GET.view|default:'grid' %}
                <ul class="product-grid product-grid--{{ current_view }}">
                    {% for product in object_list %}

                        <li class="product-card">

                            <a class="product-thumb js-qv"
                               href="#"
                               data-qv-url="{% url 'jewel-quick-view' pk=product.pk slug=product.slug %}">
                                {% with p=product.photos.all.0 %}
                                    {% if p %}
                                        <img src="{{ p.image.url }}" alt="{{ product.name }}">
                                    {% else %}
                                        <img src="{% static 'images/placeholders/category.jpg' %}"
                                             alt="{{ product.name }}">
                                    {% endif %}
                                {% endwith %}
                            </a>

                            <div class="product-info">
                                <h2 class="product-title product-title--big">
                                    <a class="js-qv" href="#"
                                       data-qv-url="{% url 'jewel-quick-view' pk=product.pk slug=product.slug %}"
                                    >{{ product.name }}</a>
                                </h2>

                                <div class="rating-stars"
                                     data-avg="{{ product.rating_avg|default:0 }}"
                                     data-count="{{ product.rating_count|default:0 }}"
                                     data-my="{{ user_ratings_map|get_item:product.id }}"
                                     data-show-count="0"
                                     data-rate-url="{% url 'api:rate-jewel' pk=product.id %}"
                                     aria-label="Rating">
                                    {% for _ in "12345" %}
                                        <button type="button" class="star" data-value="{{ forloop.counter }}"
                                                aria-label="{{ forloop.counter }} star">
                                            <i class="far fa-star"></i>
                                        </button>
                                    {% endfor %}
                                    <span class="rating-count">({{ product.rating_avg|default:0|floatformat:1 }}/5)</span>
                                </div>

                                <div class="card-actions">
                                    <button class="like-btn {% if product.is_liked %} liked{% endif %}"
                                            type="button"
                                            data-jewel-id="{{ product.id }}"
                                            data-url="{% url 'toggle-like' product.id %}"
                                            aria-pressed="{% if product.is_liked %}true{% else %}false{% endif %}"
                                            title="{% if product.is_liked %}Unlike{% else %}Like{% endif %}"
                                    >
                                        <i class="{% if product.is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                                    </button>
                                </div>

                                <div class="price-row">
                                    <span class="price price--big">
                                    {{ product.price }} BGN
                                    <span class="price-eur">({{ product.price|to_eur }} €)</span>
                                    </span>

                                    <a class="btn btn-details"
                                       href="{% url 'jewel-details' pk=product.id slug=product.slug %}">Details</a>
                                </div>
                            </div>

                            {% if request.GET.view == 'list' %}
                                <div class="product-extra">
                                    {% with s=product.short_description|default_if_none:'' l=product.long_description|default_if_none:'' %}
                                        {% if s or l %}
                                            <p class="snip-text">
                                                {{ s|striptags }}{% if s and l %}<br><br>{% endif %}{{ l|striptags }}
                                            </p>
                                        {% endif %}
                                    {% endwith %}

                                    <ul class="snip-specs">
                                        {% for s in product.specs.all %}
                                            <li>
                                                {% if s.label %}<strong>{{ s.label }}:</strong>{% endif %}
                                                {{ s.value }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </li>

                    {% empty %}
                        <p>No products for this filter.</p>
                    {% endfor %}

                </ul>
            {% endwith %}

            {% if is_paginated %}
                <nav class="pagination">
                    {% if page_obj.has_previous %}
                        <a class="page prev"
                           href="?{{ qs }}{% if qs %}&{% endif %}page={{ page_obj.previous_page_number }}">‹</a>
                    {% endif %}
                    {% for p in paginator.page_range %}
                        <a class="page {% if p == page_obj.number %}active{% endif %}"
                           href="?{{ qs }}{% if qs %}&{% endif %}page={{ p }}">{{ p }}</a>
                    {% endfor %}
                    {% if page_obj.has_next %}
                        <a class="page next"
                           href="?{{ qs }}{% if qs %}&{% endif %}page={{ page_obj.next_page_number }}">›</a>
                    {% endif %}
                </nav>
            {% endif %}

        </section>
    </main>

    {% block category_js %}
        <script src="{% static 'js/components/category.js' %}" defer></script>
    {% endblock %}

{% endblock %}
